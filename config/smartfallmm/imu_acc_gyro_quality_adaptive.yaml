# Accelerometer + Gyroscope with Adaptive Quality Fallback
# 6 channels when gyro quality good: [ax, ay, az, gx, gy, gz]
# 4 channels when gyro quality poor: [smv, ax, ay, az] (fallback to acc-only)
#
# Adaptive mode: Automatically falls back to accelerometer-only when
# gyroscope quality is poor (SNR < threshold), rather than discarding trials.
#
# Advantages over hard filtering:
# - Preserves all samples (no data loss)
# - Dynamically adapts to per-trial quality
# - Leverages high-quality gyro when available
# - Falls back gracefully when gyro is noisy
#
# Trade-off:
# - Variable input channels (mixed 4ch and 6ch batches)
# - Model sees both modalities during training
# - More robust to sensor quality variations
#
# References:
#   Liu et al. (2022). "Hybrid learning-based stochastic noise eliminating
#   method with attention-Conv-LSTM network." Frontiers in Neurorobotics.
#   DOI: 10.3389/fnbot.2022.993936

model: Models.imu_transformer.IMUTransformer
dataset: smartfallmm

# Leave-One-Subject-Out (LOSO) setup matching baseline
subjects: [29,30,31,32,34,35,36,37,38,39,43,44,45,46,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63]
validation_subjects: [38, 44]  # Subjects [38, 44]: ~60% ADLs for both acc-only and acc+gyro
# Subjects with poor gyroscope data - permanently in training, never tested (consistency across all configs)
train_only_subjects: [29, 30, 32, 35, 39, 59]  # Subjects with poor gyro data or imbalanced class distribution

model_args:
  # NOTE: This config requires dynamic channel handling
  # Model will receive both 4-channel (acc-only) and 6-channel (acc+gyro) inputs
  # For now, set to 6 channels (auto-tunes to 80 dim)
  # TODO: May need dynamic architecture or padding to handle mixed channels
  imu_channels: 6              # Max channels (when gyro quality is good)
  acc_coords: 6                # Alias for backward compatibility
  num_classes: 1               # Binary fall detection
  imu_frames: 128
  acc_frames: 128
  mocap_frames: 128
  dropout: 0.5                 # Matching TransModel baseline
  auto_tune: True              # Enable channel-based auto-tuning
  # Architecture will be auto-selected: num_heads=4, num_layers=2, embed_dim=80

dataset_args:
  mode: 'sliding_window'
  max_length: 128
  task: 'fd'
  modalities: ['accelerometer', 'gyroscope']  # Both modalities (with fallback)
  age_group: ['young']
  sensors: ['watch']
  use_skeleton: False

  # Standard preprocessing (matching baseline)
  enable_filtering: False
  filter_cutoff: 5.5
  filter_fs: 25
  enable_normalization: False
  discard_mismatched_modalities: True  # Drop trials where acc/gyro lengths differ
  length_sensitive_modalities: ['accelerometer', 'gyroscope']

  # Motion filtering (disabled for this experiment)
  enable_motion_filtering: False

  # Quality filtering (ADAPTIVE MODE - fallback to acc-only)
  enable_gyro_quality_check: True
  quality_mode: 'adaptive'       # Fall back to acc-only if gyro quality poor
  quality_threshold_snr: 1.0     # Minimum acceptable SNR
  quality_method: 'simple'       # Fast SNR-based check

  # Sensor fusion (disabled - using raw gyro when quality is good)
  enable_sensor_fusion: False

# Training configuration (matching baseline for fair comparison)
batch_size: 64
test_batch_size: 64
val_batch_size: 64
num_epoch: 80

# DataLoader
feeder: Feeder.Make_Dataset.UTD_mm

train_feeder_args:
  batch_size: 64

val_feeder_args:
  batch_size: 64

test_feeder_args:
  batch_size: 64

# Reproducibility + Optimizer (matching baseline)
seed: 2
optimizer: adamw
base_lr: 1e-3
weight_decay: 1e-3

# Expected behavior:
# - All 1700 samples retained (no data loss)
# - ~35% trials use 6-channel input (acc+gyro, high quality)
# - ~65% trials use 4-channel input (acc-only, poor gyro quality)
# - Model learns to work with both configurations
# - Should outperform hard filtering (more data) and raw baseline (quality-aware)
#
# Implementation note:
# - Current implementation in loader.py removes 'gyroscope' key when quality fails
# - Make_Dataset.py will then use accelerometer-only path
# - Model receives 4-channel input with SMV for poor-quality trials
# - Model receives 6-channel input without SMV for good-quality trials
#
# Potential issue:
# - Mixed channel counts in same batch may cause dimension mismatch
# - Consider zero-padding to 6 channels or separate batch handling
